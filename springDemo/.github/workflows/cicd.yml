name: CICD

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  compile:
    name: Compile Java Project
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/setup-java@v4


      - name: Set up JDK 17
        uses: actions/checkout@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Cache Maven repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build with Maven
        run: mvn -B clean compile

  security-check:
    name: Security Scan (Trivy + Gitleaks)
    runs-on: ubuntu-latest
    needs: compile

    steps:
      - name: Checkout Code


      - name: Install dependencies (Trivy & Gitleaks)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release curl
          
          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update -y
          sudo apt-get install -y trivy
          
          # Install Gitleaks
          if ! command -v gitleaks >/dev/null 2>&1; then
            curl -sSfL https://github.com/zricethezav/gitleaks/releases/latest/download/gitleaks_$(uname -s)_$(uname -m).tar.gz \
              | tar -xzv -C /tmp
            sudo mv /tmp/gitleaks /usr/local/bin/gitleaks || true
          fi

      - name: Run Trivy FS Scan
        run: trivy fs --format table -o fs-report.txt .

      - name: Run Gitleaks Scan
        run: gitleaks detect --source . --report-path gitleaks-report.json --report-format json

      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            fs-report.txt
            gitleaks-report.json